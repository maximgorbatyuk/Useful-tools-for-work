# TP.Tools NuGet Upgrade Script

A bash script that automates upgrading all `TP.Tools.*` NuGet packages across a .NET solution. Generated by Claude 4.5 Sonnet.

## Features

- ðŸ” **Auto-discovery** - Finds all `TP.Tools.*` packages across all `.csproj` files
- âœ… **Version validation** - Ensures version follows `1.0.****` pattern
- ðŸ›¡ï¸ **Branch protection** - Prompts for new branch when on protected branches
- ðŸ”¨ **Build verification** - Runs `dotnet build` and stops on failure
- ðŸ§ª **Test verification** - Runs `dotnet test` and reports failures
- ðŸ“ **Auto-commit** - Commits changes with standardized message

## Requirements

- macOS or Linux
- Bash 4.0+
- .NET SDK (`dotnet` CLI)
- Git

## Installation
```bash
# Copy script to your repository root
cp upgrade-nugets.sh /path/to/your/solution/

# Make executable
chmod +x upgrade-nugets.sh
```

## Usage

Run from your solution root directory:
```bash
./upgrade-nugets.sh
```

## Workflow

| Step | Action | On Failure |
|------|--------|------------|
| 1 | Scan `.csproj` files for `TP.Tools.*` packages | Exit if none found |
| 2 | Prompt for target version (`1.0.****`) | Re-prompt until valid |
| 3 | Check branch, prompt for new if protected | Must provide valid branch name |
| 4 | Upgrade all packages via `dotnet add package` | Exit on error |
| 5 | Run `dotnet build` | Show errors and exit |
| 6 | Run `dotnet test` | Show failed tests and exit |
| 7 | Commit changes | Skip if no changes |

## Protected Branches

The script will prompt for a new branch when on:

- `main`
- `master`
- `dev`
- `development`
- `sandbox`

## Example Output
```
========================================
   TP.Tools NuGet Upgrade Script
========================================

Found 5 .csproj file(s)

Step 1: Searching for TP.Tools.* packages...

Found 4 unique TP.Tools.* package(s):

  â€¢ TP.Tools.Common (current: 1.0.100)
  â€¢ TP.Tools.Logging (current: 1.0.98)
  â€¢ TP.Tools.Auth (current: 1.0.100)
  â€¢ TP.Tools.Messaging (current: 1.0.95)

Step 2: Enter target version

Enter upgrade version (format: 1.0.****): 1.0
Invalid version format. Please use format: 1.0.**** (e.g., 1.0.123, 1.0.4567)
Enter upgrade version (format: 1.0.****): 1.0.150
Version accepted: 1.0.150

Step 3: Checking git branch...

Current branch: development
Warning: You are on a protected branch (development)

Enter new branch name to checkout: feature/upgrade-nugets-1.0.150
Creating and switching to branch: feature/upgrade-nugets-1.0.150

Step 4: Upgrading packages to version 1.0.150...

Upgrading TP.Tools.Common to 1.0.150...
  âœ“ Updated in Api.csproj
  âœ“ Updated in Core.csproj
  âœ“ Updated in Infrastructure.csproj
Upgrading TP.Tools.Logging to 1.0.150...
  âœ“ Updated in Api.csproj
  âœ“ Updated in Worker.csproj
Upgrading TP.Tools.Auth to 1.0.150...
  âœ“ Updated in Api.csproj
Upgrading TP.Tools.Messaging to 1.0.150...
  âœ“ Updated in Worker.csproj
  âœ“ Updated in Infrastructure.csproj

All packages upgraded successfully!

Step 5: Building solution...

MSBuild version 17.8.0 for .NET
  Determining projects to restore...
  All projects are up-to-date for restore.
  Core -> /src/Core/bin/Debug/net8.0/Core.dll
  Infrastructure -> /src/Infrastructure/bin/Debug/net8.0/Infrastructure.dll
  Api -> /src/Api/bin/Debug/net8.0/Api.dll
  Worker -> /src/Worker/bin/Debug/net8.0/Worker.dll

Build succeeded.
    0 Warning(s)
    0 Error(s)

Build succeeded!

Step 6: Running tests...

  Determining projects to restore...
  All projects are up-to-date for restore.
  Core.Tests -> /tests/Core.Tests/bin/Debug/net8.0/Core.Tests.dll
  Api.Tests -> /tests/Api.Tests/bin/Debug/net8.0/Api.Tests.dll

Test run for /tests/Core.Tests/bin/Debug/net8.0/Core.Tests.dll (.NETCoreApp,Version=v8.0)
Microsoft (R) Test Execution Command Line Tool Version 17.8.0
Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    42, Skipped:     0, Total:    42

Test run for /tests/Api.Tests/bin/Debug/net8.0/Api.Tests.dll (.NETCoreApp,Version=v8.0)
Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    28, Skipped:     0, Total:    28

All tests passed!

Step 7: Committing changes...

[feature/upgrade-nugets-1.0.150 a1b2c3d] Nugets upgraded
 5 files changed, 8 insertions(+), 8 deletions(-)

Changes committed successfully!

========================================
   Upgrade completed successfully!
========================================

Branch: feature/upgrade-nugets-1.0.150
Version: 1.0.150
Packages upgraded: 4

Next steps:
  1. Review the changes: git diff HEAD~1
  2. Push to remote: git push -u origin feature/upgrade-nugets-1.0.150
```

## Example: Build Failure
```
Step 5: Building solution...

MSBuild version 17.8.0 for .NET
  Determining projects to restore...
  All projects are up-to-date for restore.
/src/Api/Controllers/UserController.cs(45,13): error CS1061: 'IAuthService' does not contain a definition for 'ValidateTokenAsync'

Build failed!

Build failed! See errors above.
```

## Example: Test Failure
```
Step 6: Running tests...

  Determining projects to restore...
  All projects are up-to-date for restore.

Failed!  - Failed:     2, Passed:    40, Skipped:     0, Total:    42

Some tests failed!

Failed tests:
  âœ— UserServiceTests.CreateUser_WithInvalidEmail_ThrowsException
  âœ— AuthServiceTests.ValidateToken_ExpiredToken_ReturnsFalse
```

## Configuration

Edit the script to customize:
```bash
# Protected branches (line 14)
PROTECTED_BRANCHES=("main" "master" "dev" "development" "sandbox")

# Package prefix (line 17)
NUGET_PREFIX="TP.Tools"

# Version pattern (line 55)
version_pattern='^1\.0\.[0-9]+$'
```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| `No .csproj files found` | Run from solution root directory |
| `No TP.Tools.* packages found` | Check package prefix matches your packages |
| Package upgrade fails | Verify package exists in NuGet source |
| Build fails | Fix code issues before re-running |
| Tests fail | Fix failing tests or run script again after fixes |

## License

MIT License